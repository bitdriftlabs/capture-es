name: Auto release React Native after upon a new capture-sdk release
on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  auto-publish:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.title, 'Update React Native version with Capture SDK') && github.event.pull_request.user.login == 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: ./.github/actions/javascript-setup
        
      - name: Get React Native version from package.json
        id: extract-version
        run: |
          # Get the current version from package.json after the PR is merged
          CURRENT_RN_VERSION=$(node -p "require('./packages/react-native/package.json').version")
          echo "rn_version=$CURRENT_RN_VERSION" >> $GITHUB_OUTPUT
          echo "Current React Native version from package.json: $CURRENT_RN_VERSION"
                    
      - name: Trigger React Native release workflow
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.extract-version.outputs.rn_version }}';
            console.log(`Auto-publishing React Native package version: ${version}`);
            
            // Trigger the React Native release workflow directly by workflow ID
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'react-native-release',
              ref: 'main',
              inputs: {
                version: version
              }
            });
            
            console.log(`Successfully triggered React Native Release workflow for version ${version}`);
            console.log('Package will be published to npm automatically');
            
      - name: Create release summary
        run: |
          echo "## Auto-Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **React Native Version:** ${{ steps.extract-version.outputs.rn_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Auto-publish workflow triggered" >> $GITHUB_STEP_SUMMARY
          echo "- **Next Step:** React Native Release workflow will publish to npm" >> $GITHUB_STEP_SUMMARY
